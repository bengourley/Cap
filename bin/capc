#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander'),
		fs = require('fs'),
		createCompiler = require('../lib/compiler');

program
	.version('0.0.1')
	.option(
		'-t, --printtree',
		'print the syntax tree instead of compiling (forces --print)'
	)
	.option(
		'-p, --print',
		'print the output instead of writing to file'
	)
	.option(
		'-c, --compress',
		'compress the output'
	);


// Custom help
program.on('--help', function(){
  console.log('  Example:');
  console.log('');
  console.log('    $ capc example.cap');
  console.log('');
  console.log('    Compiles example.cap -> example.cap.js');
  console.log('');
});

program.parse(process.argv);

if (!program.args[0]) {
	
	console.log('No file supplied!');

} else {

	// Read the file from the path supplied
	fs.readFile(program.args[0], 'utf8', function (err, data) {

		if (err) {
			if (err.code === 'ENOENT') {
				console.log('No file at `' + program.args[0] + '`');
				return;
			}
		} else {
			throw err;
		}
		
		var output = createCompiler().compile(data, {
			tree : program.printtree,
			compress : program.compress
		});

		if (program.print) {
			
			console.log(output);

		} else {
			fs.writeFile(program.args[0] + '.js', output, function (err) {
				
				if (err) throw err;

				console.log(program.args[0] + ' -> ' + program.args[0] + '.js');

			});
		}

	});

}