#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander'),
	fs = require('fs'),
	Parser = require('jison').Parser,
	lexer = require('../lib/lexer'),
	nodes = require('../lib/nodes'),
	parser = require('../lib/parser.js').parser;

program
	.version('0.0.1')
	.option('-p, --print', 'print the compiled js instead of outputting to file')
	.option('-t, --tree', 'pretty print the nodes in the AST instead of compiling to file')
	.option('-g, --grammar [grammar]', 'generate a parser on the fly with the given grammar file')
	.parse(process.argv);

var compile = function (print) {

	fs.readFile(program.args[0], 'utf8', function (err, data) {

		// Assign custom lexer
		parser.lexer = lexer();
	
		// Add AST nodes for use in grammar
		parser.yy.nodes = nodes;
		try {
			var AST = parser.parse(data);
			console.log(print ? AST.print() : AST.compile());
		} catch (e) {
			// Catch a parser error for non-ugly output
			if (/^Parse error/.test(e.message)) {
				console.log(e.message);
			} else {
				// But throw any other exception
				throw e;
			}
		}

	});
};

if (!program.args[0]) {
	console.log('No file supplied!');
} else {

	if (program.grammar) {
		fs.readFile(program.grammar, 'utf8', function (err, data) {
			parser = new Parser(data);
			compile(program.print);
		});
	} else {

		compile(program.print);

	}

}
