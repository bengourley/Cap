#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander'),
	fs = require('fs'),
	createLexer = require('../lib/lexer'),
	createParser = require('../lib/parser'),
	createGenerator = require('../lib/generator'),
	createErrorReporter = require('../lib/errorReporter');

program
	.version('0.0.1')
	.option(
		'-p, --printtree',
		'print the syntax tree instead of compiling'
	)
	.parse(process.argv);

if (!program.args[0]) {
	console.log('No file supplied!');
} else {

	fs.readFile(program.args[0], 'utf8', function (err, data) {

			var errorReporter = createErrorReporter(data),
					lexer = createLexer(),
					parser = createParser(lexer, errorReporter),
					generator = createGenerator(parser, errorReporter);

			try {
				var ast = parser.parse(data);
				console.log(generator.generate({
					ast : ast,
					tree : program.printtree
				}));
				} catch (e) {
					if (['ParseError', 'SemanticError'].indexOf(e.type) === -1) throw e;
					console.log(e.message);
				}

	});
}